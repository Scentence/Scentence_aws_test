# λ μ΄μ–΄λ§ μ‹μ¤ν… λ™μ‘ μ›λ¦¬ μƒμ„Έ λ¶„μ„

## 1. μ‹μ¤ν… κ°μ” (System Overview)
Layering μ„λΉ„μ¤λ” **FastAPI**λ΅ κµ¬μ¶•λ λ³„λ„μ λ§μ΄ν¬λ΅μ„λΉ„μ¤λ΅, λ²΅ν„° μ—°μ‚°(Vector Math)μ„ ν†µν•΄ λ‘ ν–¥μμ κ¶ν•©(Harmony)κ³Ό μ‚¬μ©μκ°€ μ›ν•λ” μλ„(Target)λ¥Ό μν•™μ μΌλ΅ κ³„μ‚°ν•μ—¬ μµμ μ μ΅°ν•©μ„ μ¶”μ²ν•©λ‹λ‹¤.

### ν•µμ‹¬ μ•„ν‚¤ν…μ²
- **Endpoint**: `main.py`μ `/layering/recommend`
- **Logic**: `agent/tools.py`μ `rank_recommendations` λ° `calculate_advanced_layering`
- **Data**: `agent/database.py` (In-memory CSV Loading)
- **Constants**: `agent/constants.py` (Accord, Keyword Mappings)

---

## 2. λ™μ‘ μμ‹: "λ‚λ” ck oneμ„ κ°–κ³  μλ”λ° μΆ€ λ” μ‹νΈλ¬μ¤ν• λλ‚μ΄ λ‚κ² λ μ΄μ–΄λ§ν•  ν–¥μ μ¶”μ²ν•΄μ¤"

μ‚¬μ©μκ°€ μ„μ™€ κ°™μ΄ μ…λ ¥ν–μ„ λ•, μ‹μ¤ν… λ‚΄λ¶€μ μ²λ¦¬ κ³Όμ •μ„ λ‹¨κ³„λ³„λ΅ μƒμ„Έν μ„¤λ…ν•©λ‹λ‹¤.

### π“ Step 1: μ”μ²­ λ°μ΄ν„° νμ‹± (Parsing)
ν”„λ΅ νΈμ—”λ“λ‚ μƒμ„ μ—μ΄μ „νΈκ°€ μ‚¬μ©μμ μμ—°μ–΄ μ…λ ¥μ„ λ¶„μ„ν•μ—¬ λ‹¤μκ³Ό κ°™μ€ JSON νμ΄λ΅λ“λ΅ λ³€ν™ν•΄ APIλ¥Ό νΈμ¶ν•©λ‹λ‹¤.
```json
{
  "base_perfume_id": "ck_one_id",
  "keywords": ["citrus", "more citrus"]
}
```
> **[μ°Έκ³ ]** μ‹¤μ λ΅λ” "citrus"λΌλ” ν•µμ‹¬ ν‚¤μ›λ“κ°€ μ¶”μ¶λμ–΄ μ „λ‹¬λ©λ‹λ‹¤.

### π“ Step 2: νƒ€κ² λ²΅ν„° μƒμ„± (Target Vector Creation)
μ‹μ¤ν…μ€ μ‚¬μ©μκ°€ μ›ν•λ” "μ‹νΈλ¬μ¤ν• λλ‚"μ„ μν•™μ μΈ λ©ν‘ μ§€μ (Vector)μΌλ΅ λ³€ν™ν•©λ‹λ‹¤.

1. **ν‚¤μ›λ“ λ§¤ν•‘ (`constants.py`)**:
   - `KEYWORD_MAP["citrus"]` -> `["Citrus", "Fresh"]`
   - μ¦‰, "μ‹νΈλ¬μ¤ν•λ‹¤"λ” λ§μ€ "Citrus + Fresh" μ–΄μ½”λ“λ¥Ό μλ―Έν•λ‹¤κ³  μ •μλμ–΄ μμµλ‹λ‹¤.

2. **λ²΅ν„° λ¶€μ¤ν… (`tools.py` - `get_target_vector`)**:
   - 21κ°€μ§€ μ–΄μ½”λ“ μ¶•μ„ κ°€μ§„ 0λ²΅ν„°μ—μ„ μ‹μ‘ν•©λ‹λ‹¤.
   - λ§¤ν•‘λ `Citrus`μ™€ `Fresh` μ¶•μ— κ°κ° `30.0`μ΄λΌλ” **κ°•λ ¥ν• κ°€μ¤‘μΉ(Boost)**λ¥Ό λ”ν•©λ‹λ‹¤.
   - **κ²°κ³Ό**: `[0, 30.0, 0, ..., 30.0, ...]` (Citrusμ™€ Freshκ°€ λ§¤μ° κ°•ν•κ² μ„¤μ •λ λ²΅ν„°)

### π“ Step 3: ν›„λ³΄κµ° μν λ° μ μ κ³„μ‚° (Scoring Loop)
DBμ— μλ” λ¨λ“  ν–¥μ(Candidate)λ¥Ό ν•λ‚μ”© κΊΌλ‚΄μ–΄, **CK One(Base)**κ³Ό μ„μ—μ„ λ•μ μ μλ¥Ό κ³„μ‚°ν•©λ‹λ‹¤. μ μ κ³„μ‚° ν•¨μλ” `calculate_advanced_layering`μ…λ‹λ‹¤.

**β‘  κΈ°λ³Έ λ²΅ν„° λ΅λ”©**
- **Base (CK One)**: `[Citrus: 15, Fresh: 10, Green: 5, ...]` (μƒνΌν•κ³  κ°€λ²Όμ΄ ν–¥)
- **Candidate (ν›„λ³΄ X)**: `[Citrus: 20, Woody: 5, ...]` (κ°€μ •)

**β‘΅ λ μ΄μ–΄λ§ κ²°κ³Ό μμΈ΅ (Simulation)**
- λ‘ ν–¥μλ¥Ό μ„μ—μ„ λ•μ μμƒ ν–¥(Result Vector)μ„ κµ¬ν•©λ‹λ‹¤.
- κ³µμ‹: `(Base + Candidate) / 2` (λ‹¨μ ν‰κ· )

**β‘Ά 4κ°€μ§€ ν•µμ‹¬ ν‰κ°€ μ§€ν‘ (Scoring Metrics)**

| μ§€ν‘ | μ„¤λ… | λ΅μ§ (`tools.py`) |
| :--- | :--- | :--- |
| **1. Harmony (μ΅°ν™”)** | λ‘ ν–¥μμ λ² μ΄μ¤ λ…ΈνΈκ°€ μ–Όλ§λ‚ κ²ΉμΉλ”κ°€? | `_harmony_score`: λ² μ΄μ¤ λ…ΈνΈ κµμ§‘ν•©/ν•©μ§‘ν•© λΉ„μ¨ (μ μ‚¬λ„κ°€ 0.4~0.7μΌ λ• μµκ³ μ ) |
| **2. Bridge (μ—°κ²°μ„±)** | μ¤‘κ°„ κ°•λ„μ κ³µν†µ μ–΄μ½”λ“κ°€ μλ”κ°€? | `_bridge_bonus`: λ‘ ν–¥μ λ¨λ‘ νΉμ • μ–΄μ½”λ“κ°€ 5~15 μ‚¬μ΄μΌ λ• λ³΄λ„μ¤ λ¶€μ—¬ |
| **3. Penalty (μ¶©λ)** | μ„λ΅ μ–΄μΈλ¦¬μ§€ μ•λ” ν–¥μ΄ μλ”κ°€? | `_clash_penalty`: `CLASH_PAIRS` ν™•μΈ (μ: Aquatic vs Gourmand μ„μ΄λ©΄ κ°μ ) |
| **4. Target (λ©ν‘ μ ν•©μ„±)** | **[ν•µμ‹¬]** μ„μ€ κ²°κ³Όκ°€ λ©ν‘ λ²΅ν„°μ™€ κ°€κΉμ΄κ°€? | `_target_match_score`: μμƒ κ²°κ³Ό λ²΅ν„°μ™€ Target λ²΅ν„° κ°„μ μ ν΄λ¦¬λ“ κ±°λ¦¬ μ—­μ‚° |

> **CK One μμ‹ μ μ©**:
> μ‚¬μ©μκ°€ "λ” μ‹νΈλ¬μ¤ν•κ²"λ¥Ό μ›ν–μΌλ―€λ΅, Candidateκ°€ Citrus μ„±λ¶„μ΄ λ§μ„μλ΅ μ„μΈ κ²°κ³Όμ Citrus μμΉκ°€ λ†’μ•„μ Έ Target λ²΅ν„°(Citrus 30)μ™€ κ°€κΉμ›μ§‘λ‹λ‹¤. λ”°λΌμ„ **Target μ μκ°€ κΈ‰μƒμΉ**ν•©λ‹λ‹¤.

### π“ Step 4: μ‹¤ν„ κ°€λ¥μ„± κ²€μ‚¬ (Feasibility Guard)
λ‹¨μν μ μλ§ λ†’λ‹¤κ³  μ¶”μ²ν•μ§€ μ•μµλ‹λ‹¤. `_feasibility_guard` ν•¨μκ°€ "μ •λ§ μλ„λ€λ΅ λ μ§€" κ²€μ¦ν•©λ‹λ‹¤.
- **Target Threshold**: λ©ν‘ μ μκ°€ `0.6` λ―Έλ§μ΄λ©΄ "μλ„ λ‹¬μ„± μ‹¤ν¨"λ΅ κ°„μ£Όν•μ—¬ νƒλ½μ‹ν‚µλ‹λ‹¤.
- **Clash Check**: μ„μΈ κ²°κ³Όμ μ£Όμ” ν–¥(Dominant Accords)λΌλ¦¬ μ¶©λν•μ§€ μ•λ”μ§€ λ‹¤μ‹ ν™•μΈν•©λ‹λ‹¤.

### π“ Step 5: μµμΆ… λ­ν‚Ή λ° λ°ν™ (Ranking)
1. λ¨λ“  ν›„λ³΄κµ°μ `total_score` (1.0 + Harmony + Bridge + Penalty + Target)λ¥Ό κΈ°μ¤€μΌλ΅ λ‚΄λ¦Όμ°¨μ μ •λ ¬ν•©λ‹λ‹¤.
2. μƒμ„ 3κ°λ¥Ό λ½‘μµλ‹λ‹¤.
3. **Spray Order**: μ§€μ†λ ¥(`persistence_score`)μ΄ λ” κ°•ν• ν–¥μλ¥Ό λ¨Όμ € λΏλ¦¬λΌκ³  μ•λ‚΄ν•κΈ° μ„ν•΄ μμ„λ¥Ό μ •ν•΄μ¤λ‹λ‹¤. (μ: "Woodyν• ν–¥μλ¥Ό λ¨Όμ € λΏλ¦¬κ³ , κ°€λ²Όμ΄ Citrusλ¥Ό λ‚μ¤‘μ— λΏλ¦¬μ„Έμ”")

---

## 3. λ™μ‘ μμ‹: "CK Oneμ— μ–΄μΈλ¦΄λ§ν• ν–¥μ μ¶”μ²ν•΄μ¤" (Generic Case)

μ‚¬μ©μκ°€ κµ¬μ²΄μ μΈ ν‚¤μ›λ“ μ—†μ΄ λ‹¨μν "μ–΄μΈλ¦¬λ” ν–¥μ"λ¥Ό μ¶”μ²ν•΄λ‹¬λΌκ³  ν•  λ•μ λ™μ‘ λ°©μ‹μ…λ‹λ‹¤.

### π“ Step 1: μλ„ νμ•… λ° ν‚¤μ›λ“ μ¶”μ¶
- **Input**: "ck oneμ— μ–΄μΈλ¦΄λ§ν• ν–¥μ μ¶”μ²ν•΄μ¤"
- **Analysis (`graph.py`)**: `analyze_user_input` ν•¨μκ°€ μ‹¤ν–‰λ©λ‹λ‹¤.
    - μ…λ ¥ ν…μ¤νΈ λ‚΄μ— `KEYWORD_MAP`μ— μ •μλ νΉμ • ν‚¤μ›λ“(citrus, cool, warm λ“±)κ°€ μλ”μ§€ κ²€μ‚¬ν•©λ‹λ‹¤.
    - μ΄λ² μμ‹μ κ²½μ°, λ§¤μΉ­λλ” ν‚¤μ›λ“κ°€ **μ—†μµλ‹λ‹¤**.
- **Result**: `keywords = []` (λΉ λ¦¬μ¤νΈ), `intensity = 0.5` (κΈ°λ³Έκ°’)

### π“ Step 2: Target Vector = Zero Vector
- ν‚¤μ›λ“κ°€ μ—†μΌλ―€λ΅, `get_target_vector` ν•¨μλ” λ¨λ“  κ°’μ΄ 0μΈ λ²΅ν„°(`[0, 0, ..., 0]`)λ¥Ό λ°ν™ν•©λ‹λ‹¤.
- μ¦‰, **"νΉμ • ν–¥μ„ λ©ν‘λ΅ ν•μ§€ μ•μ"**μ„ μλ―Έν•©λ‹λ‹¤.

### π“ Step 3: μ μ κ³„μ‚° (Harmony & Bridge μ¤‘μ‹¬)
Target Vectorκ°€ 0μ΄λ―€λ΅, `Target Score`μ μν–¥λ ¥μ΄ μ‚¬μ‹¤μƒ λ¬΄λ ¥ν™”λκ±°λ‚ κ³ μ •λ©λ‹λ‹¤. λ”°λΌμ„ **κΈ°λ³Έμ μΈ κ¶ν•©(Chemistry)** μ μκ°€ λ­ν‚Ήμ„ κ²°μ •ν•κ² λ©λ‹λ‹¤.

1.  **Harmony Score (λ² μ΄μ¤ λ…ΈνΈ κ¶ν•©) [β…κ²°μ •μ ]**
    - λ‘ ν–¥μμ λ² μ΄μ¤ λ…ΈνΈ(μ”ν–¥)κ°€ μ„λ΅ μ–Όλ§λ‚ λΉ„μ·ν•μ§€ λ΄…λ‹λ‹¤.
    - λ² μ΄μ¤κ°€ μ•„μ λ‹¤λ¥΄λ©΄ μ΄μ§κ°μ΄ λ“¤ μ μλ”λ°, μ΄ λ΅μ§μ„ ν†µν•΄ **"μ„μ€μ„ λ• κ±°λ¶€κ°μ΄ μ—†λ” ν–¥μ"**κ°€ μƒμ„κ¶μ— μ¤λ¦…λ‹λ‹¤.

2.  **Bridge Bonus (μ—°κ²° κ³ λ¦¬)**
    - λ‘ ν–¥μκ°€ κ³µμ ν•λ” μ¤‘κ°„ κ°•λ„μ μ–΄μ½”λ“κ°€ μλ”μ§€ λ΄…λ‹λ‹¤.
    - μ: λ‘ λ‹¤ 'Floral'μ΄ μ λ‹Ήν μλ‹¤λ©΄, μ΄ κ³µν†µμ μ΄ λ‘ ν–¥μλ¥Ό μμ—°μ¤λ½κ² μ΄μ–΄μ£Όλ” λ‹¤λ¦¬ μ—­ν• μ„ ν•©λ‹λ‹¤.

3.  **Penalty Check (μ¶©λ λ°©μ§€)**
    - `Aquatic`κ³Ό `Gourmand`(λ‹¬λ‹¬ν• ν–¥)μ²λΌ μƒκ·ΉμΈ ν–¥μ΄ μ„μ΄μ§€ μ•λ„λ΅ ν•„ν„°λ§ν•©λ‹λ‹¤.

### π“ Step 4: κ²°κ³Ό λ°ν™
- **μ¶”μ² κΈ°μ¤€**: "CK Oneκ³Ό λ² μ΄μ¤ λ…ΈνΈκ°€ λΉ„μ·ν•κ³ (Harmony), κ³µν†µλ ν–¥μ΅°λ¥Ό κ°€μ§€κ³  μμ–΄(Bridge) μμ—°μ¤λ½κ² μ–΄μ°λ¬μ§€λ” ν–¥μ"
- **νΉμ§•**: λ¨ν—μ μΈ μ‹λ„λ³΄λ‹¤λ” **μ‹¤ν¨ν•  ν™•λ¥ μ΄ λ‚®μ€ μ•μ „ν• μ΅°ν•©(Safe Pairing)**μ΄ μ¶”μ²λ©λ‹λ‹¤.

---

## 4. λ™μ‘ μμ‹: "CK Oneμ΄λ‘ μ΅°λ§λ΅  μ°λ“μ„Έμ΄μ§€ & μ”¨μ†”νΈλ‘ λ μ΄μ–΄λ§ν•λ©΄ μ–΄μΈλ¦΄κΉ?" (Specific Pair Check)

μ‚¬μ©μκ°€ **νΉμ • ν–¥μ 2κ°**λ¥Ό μ½• μ§‘μ–΄μ„ κ¶ν•©μ„ λ¬Όμ–΄λ³΄λ” κ²½μ°μ…λ‹λ‹¤.
ν„μ¬ API(`main.py`)μ—λ” λ‘ ν–¥μ IDλ¥Ό μ§μ ‘ λΉ„κµν•λ” μ—”λ“ν¬μΈνΈκ°€ λ…μ‹μ μΌλ΅ λ“λ¬λ‚μ§€ μ•μΌλ‚, λ‚΄λ¶€ μ—”μ§„(`tools.py`)μ€ μ΄λ―Έ μ΄ κΈ°λ¥μ„ μ™„λ²½ν•κ² μ§€μ›ν•κ³  μμµλ‹λ‹¤.

λ§μ•½ μ΄ κΈ°λ¥μ„ μν–‰ν•λ‹¤λ©΄, λ‚΄λ¶€μ μΌλ΅ μ•„λμ™€ κ°™μ΄ λ™μ‘ν•©λ‹λ‹¤.

### π“ Step 1: λ‘ ν–¥μμ λ²΅ν„° λ΅λ”© (Loading)
μ‹μ¤ν…μ€ DBμ—μ„ λ‘ ν–¥μμ μ¤ν™(Vector)μ„ μ¦‰μ‹ μ΅°νν•©λ‹λ‹¤.

1.  **Base (CK One)**
    - μ£Όμ” μ–΄μ½”λ“: `Citrus`, `Fresh`, `Green`
    - νΉμ§•: κ°€λ³κ³  μƒμΎν•¨.
2.  **Target (Jo Malone Wood Sage & Sea Salt)**
    - μ£Όμ” μ–΄μ½”λ“: `Aromatic`, `Salty`, `Marine`, `Citrus`
    - νΉμ§•: μ‹μ›ν•λ©΄μ„λ„ νΈμ•ν• μμ—°μ ν–¥.

### π“ Step 2: νƒ€κ² λ²΅ν„° = Zero (μλ„ μ—†μ)
μ΄ μ§λ¬Έμ€ "λ” ~ν•κ² ν•΄μ¤"κ°€ μ•„λ‹λΌ "μ μ–΄μΈλ ¤?"λ¥Ό λ¬»λ” κ²ƒμ΄λ―€λ΅, μ•μ„ Generic Caseμ™€ λ§μ°¬κ°€μ§€λ΅ **Target Vectorλ” 0**μΌλ΅ μ„¤μ •λ©λ‹λ‹¤. μ¦‰, μ μλ” μ¤λ΅μ§€ **κ¶ν•©(Chemistry)**μΌλ΅λ§ νκ°€λ¦„ λ‚©λ‹λ‹¤.

### π“ Step 3: ν•µμ‹¬ κ¶ν•© κ³„μ‚° (Scoring)
`calculate_advanced_layering(Base, Target, ZeroVector)` ν•¨μκ°€ μ‹¤ν–‰λ©λ‹λ‹¤.

1.  **Harmony Check (μ΅°ν™”)**
    - CK Oneμ μ”ν–¥(Musk, Amber)κ³Ό μ°λ“μ„Έμ΄μ§€μ μ”ν–¥(Sage, Sea Salt)μ΄ μ„μ€μ„ λ• μ΄μ§κ°μ΄ μ—†λ”μ§€ κ³„μ‚°ν•©λ‹λ‹¤.
    - λ‘ λ‹¤ 'μμ—°μ¤λ½κ³  κ°€λ²Όμ΄' μ”ν–¥μ„ κ³µμ ν•λ―€λ΅ **λ†’μ€ Harmony μ μ**κ°€ μμƒλ©λ‹λ‹¤.

2.  **Bridge Check (μ—°κ²°)**
    - λ‘ ν–¥μ λ¨λ‘ **Citrus**μ™€ **Fresh** λ‰μ•™μ¤λ¥Ό κ³µμ ν•κ³  μμµλ‹λ‹¤.
    - μ΄ κ³µν†µ λ¶„λ¨κ°€ 'λ‹¤λ¦¬(Bridge)'κ°€ λμ–΄ λ‘ ν–¥μλ¥Ό μμ—°μ¤λ½κ² μ΄μ–΄μ¤λ‹λ‹¤. **(+0.4 Bonus)**

3.  **Clash Check (μ¶©λ)**
    - CK One(Fresh)κ³Ό μ°λ“μ„Έμ΄μ§€(Marine/Aromatic)λ” μ„λ΅ μƒμ¶©λλ” `CLASH_PAIRS`μ— ν•΄λ‹Ήν•μ§€ μ•μµλ‹λ‹¤.
    - **κ°μ  μ—†μ (Penalty 0)**

### π“ Step 4: κ²°κ³Ό νλ‹¨ (Verdict)
- **μμƒ Total Score**: λ†’μ (High)
- **Feasibility**: ν†µκ³Ό (True)
- **λ‹µλ³€ μƒμ„±**:
  > "λ„¤, μ •λ§ μ μ–΄μΈλ¦¬λ” μ΅°ν•©μ΄μ—μ”! λ‘ ν–¥μ λ¨λ‘ **μ‹νΈλ¬μ¤ν•κ³  μƒμΎν• κ²°**μ„ κ³µμ ν•κ³  μμ–΄μ„(Bridge), λ§μΉ μ›λ ν•λ‚μ ν–¥μμ€λ κ²ƒμ²λΌ μμ—°μ¤λ½κ² μ„μΌ κ±°μμ”(Harmony). νΉν μ—¬λ¦„μ² μ— μ‚¬μ©ν•μ‹λ©΄ μ‹μ›ν• λλ‚μ΄ λ°°κ°€ λ  κ²ƒ κ°™μµλ‹λ‹¤."

---

## 5. μ”μ•½ (Summary)
| κµ¬λ¶„ | λ©μ μ„± μλ” λ μ΄μ–΄λ§ | λ²”μ© λ μ΄μ–΄λ§ (μ¶”μ²) | νΉμ • μ΅°ν•© ν™•μΈ (κ¶ν•©) |
| :--- | :--- | :--- | :--- |
| **Input** | "λ” μ‹νΈλ¬μ¤ν•κ²" | "μ–΄μΈλ¦¬λ” κ±° μ¶”μ²ν•΄μ¤" | "Ck one + Wood Sage μ–΄λ•?" |
| **Logic** | **Target Score** μ¤‘μ‹¬ | **Harmony + Bridge** μ¤‘μ‹¬ | **Harmony + Bridge** μ¤‘μ‹¬ |
| **νΉμ§•** | μλ„ λ‹¬μ„± μ—¬λ¶€ (Feasibility) μ¤‘μ” | μ‹¤ν¨ μ—†λ” μ•μ „ν• μ΅°ν•© μ¶”μ² | λ‘ ν–¥μμ 'κµμ§‘ν•©' μ λ¬΄κ°€ ν•µμ‹¬ |