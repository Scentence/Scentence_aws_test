version: '3.8'

services:
  # [1] 백엔드 (FastAPI)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: scentence-backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    env_file: .env
    environment:
      # .env에서 불러온 값으로 DB 접속 URL 완성
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}
    # [핵심] 도커 내부에서 'host.docker.internal'을 내 컴퓨터(Host) IP로 인식하게 함
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # [2] 프론트엔드 (Next.js)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: scentence-frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    env_file: .env
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
    depends_on:
      - backend
      
  scentmap:
    build:
      context: ./scentmap
      dockerfile: Dockerfile
    container_name: scentmap-service
    ports:
      - "8001:8001"
    volumes:
      - ./scentmap:/app/scentmap
    environment:
      - PYTHONUNBUFFERED=1
      - DB_HOST=db
      - DB_PORT=5432
      - DATABASE_URL=postgresql://scentence:scentence@db:5432/scentence_db
      - PERFUME_DATABASE_URL=postgresql://scentence:scentence@db:5432/perfume_db
      - RECOM_DATABASE_URL=postgresql://scentence:scentence@db:5432/recom_db
      - MEMBER_DATABASE_URL=postgresql://scentence:scentence@db:5432/member_db
    depends_on:
      db:
        condition: service_healthy
      data-init:
        condition: service_completed_successfully
    command: uvicorn scentmap.main:app --host 0.0.0.0 --port 8001 --reload
    env_file:
      - .env
    # environment (가장 높은 우선순위) > env_file (낮은 우선순위) 

volumes:
  pgdata:
    name: pgdata