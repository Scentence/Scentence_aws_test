# 📅 2026.01.27 작업 상세 로그 (Work Log)

## 📌 핵심 작업 목표 (Architecture Strategy)
1. **모듈 분리 및 의존성 최소화 (Minimizing Dependencies)**

    *   기존 백엔드 파일(`database.py`, `main.py`, `users.py`)의 변경 최소화
    *   archive 기능 추가 위한 신규 파일 생성
    *   **New Files**: `archive_db.py`, `routers/perfumes.py`, `routers/archive.py` 신규 생성.
    *   필수적인 import만 추가하여 기존 로직에 영향을 주지 않도록 설계.
2. **Kakao 로그인, 카카오회원의 회원전용서비스 등록**
    *   게스트 → 회원 전환 시 데이터(채팅, 향수 아카이브) 소유권 이전 로직 강화.
3. **kakao 유저 Chatbot ↔ Archive 연동 (Feature Integration)**
    *   챗봇 대화 내용 저장 및 내 아카이브(마이 향수)와의 데이터 연동 구현.

---

## 🛠 상세 구현 내용 (Implementation Details)

### 1. [ARCH] 아카이브 및 향수 로직 분리 (New Modules)
기존 `database.py`와 `users.py`를 너무 많이 수정하게되어, 변동은 최소한으로 줄이고 파일 생성함.

*   **`backend/agent/archive_db.py` (신규 생성)**
    *   **목적**: '내 향수(My Perfume)'와 관련된 모든 DB CRUD 로직을 전담.
    *   **주요 함수**:
        *   `get_my_perfumes()`: 내 향수 목록 조회 (상세 정보 조인 포함).
        *   `add_my_perfume_logic()`: 향수 등록 (중복 시 업데이트 `ON CONFLICT` 처리).
        *   `delete_my_perfume_logic()`, `update_my_perfume_logic()`: 삭제 및 상태 변경.
    *   **설계 의도**: `database.py`는 공통 연결 및 임베딩 처리만 담당하고, 비즈니스 로직은 여기로 이관하여 `circular import` 방지 및 유지보수성 향상.

*   **`backend/routers/archive.py` (신규 생성)**
    *   **목적**: 프론트엔드의 `/users/{id}/perfumes` 요청을 처리하는 별도 라우터.
    *   **특이사항**: 기존 프론트엔드 코드 수정을 최소화하기 위해 API 경로(`prefix="/users"`)는 유지하되, 물리적 파일만 분리함.

*   **`backend/routers/perfumes.py` (신규 생성)**
    *   **목적**: 향수 검색(`search`) 및 자동완성(`autocomplete`) 전담 라우터.
    *   **Connection Pool**(`get_db_connection`)을 적용하여 성능 최적화.
        *   한글/영어 혼용 검색 지원 및 공간(Space) 무시 검색 로직 추가.

### 2. [AUTH] Kakao 로그인 및 계정 통합 (Router & DB)
*   **`backend/routers/users.py` (수정)**
    *   **이메일 중복 감지 로직**: 카카오 로그인 시, 이미 같은 이메일로 가입된 로컬 계정이 있으면 `link_available: true` 응답.
    *   **`/link-account` API 신설**:
        *   기존 로컬 계정 비밀번호 검증 후 `tb_member_auth_t`에 카카오 연동 정보 추가.
        *   프로필 이미지 누락 시 카카오 정보로 자동 업데이트.
    *   **레거시 유저 마이그레이션**: 과거 로직으로 가입되어 인증 정보가 누락된 유저 자동 복구 로직 강화.

*   **`frontend/app/api/auth/[...nextauth]/route.ts` (수정)**
    *   **로그인 흐름 제어**: `link_available` 신호 수신 시 로그인 세션 생성을 중단하고 **계정 연결 페이지**로 리다이렉트 처리.
    *   **Session ID 매핑**: `session.user.id`가 항상 DB의 PK(`member_id`)를 가리키도록 보장.

### 3. [CHAT] 카카오 계정, 채팅 히스토리 저장 이슈 해결 (Database Fix)
*   **`backend/agent/database.py` (수정)**
    *   **문제**: 게스트 상태의 대화가 로그인 후에도 게스트 소유로 남아 조회 불가.
    *   **해결**: `save_chat_message` 함수 내 `ON CONFLICT` 구문 대폭 수정.
        ```python
        # 로그인 유저(member_id > 0)가 대화 시, 기존 스레드 주인을 강제로 내 ID로 변경
        MEMBER_ID = CASE WHEN EXCLUDED.MEMBER_ID > 0 THEN EXCLUDED.MEMBER_ID ...
        ```
    *   **가시성 확보**: 수정된 로직 위아래에 대형 주석(`======`) 추가하여 식별 용이하게 처리.

### 4. [UX] 프론트엔드 수정 사항
*   **`frontend/app/layering/page.tsx`**
    *   **JSDoc 문법 오류 수정**: 컴파일 에러(`; expected`)를 유발하던 잘못된 주석 포맷 수정.
    *   **로그인 상태 감지 강화**: `localStorage`와 `Session` 양쪽을 체크하여 회원 ID 누락 방지.
*   **`frontend/app/chat/page.tsx`**
    *   **ID 전송 로직**: 채팅 전송 시 `member_id`가 정확히 백엔드로 전달되도록 세션 처리 로직 보완.

### 5. 중복 이메일 계정 통합 (ing)
